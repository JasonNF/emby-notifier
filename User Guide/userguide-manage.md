## /manage 使用说明 🗃️

### 功能概览（管理员入口）
- **管理 Emby 中已有的节目**：查看详情 → 文件操作（更新 / **精细化删除**）。
- **从网盘更新一个新节目**：读取 `.nfo` → 校验 TMDB → 一键同步（复制元数据、生成 `.strm`）。

---

### 使用前提
- 仅 **超级管理员**（`ADMIN_USER_ID`）可用。
- 路径配置：
  - 主库路径 `settings.media_base_path`（示例：`/opt/Media`）
  - 网盘路径 `settings.media_cloud_path`（示例：`/opt/Cloud`）
- 若要“从 Emby 中删除节目”，需在配置中提供 Emby 用户名与密码以换取 Access Token（`emby.username`、`emby.password`）。
- TMDB 配置（用于从 `.nfo` 校验 ID 与展示详情）：`tmdb.api_token`。

---

### 命令格式
- 直接：`/manage`（进入双入口菜单）
- 或带参数：`/manage 片名 [年份]`（直接走“管理已有节目”的搜索）

---

## 一、管理 Emby 中已有的节目
### 入口
- 方式一：`/manage 片名 [年份]`
- 方式二：
  1. 发送 `/manage` →
  2. 点击 `🔄 管理Emby中已有的节目` →
  3. 机器人提示“请提供节目名称（可包含年份）或 TMDB ID”，**在群组请回复该条提示消息**提交。

### 操作步骤
1. **查看结果列表**：分页显示“序号. 标题 (年份) | 分类”。
2. **查看管理详情卡片**：点击条目进入详情（海报、剧情、规格、更新时间进度等，受设置控制）。
3. **执行管理操作**：
    - 点击 `🔄 管理该节目` → 进入“文件操作”菜单。
    - `🔄 更新该节目`：
        - **元数据/字幕/图片**（如 `.nfo`/`.ass`/`.srt`/`.jpg` 等）→ 直接复制到本地；
        - **视频等大文件** → 在本地生成同名 `.strm` 指向网盘原文件；
        - 更新完成后，原卡片会编辑为摘要，并另发一条**完整明细**，之后自动清理消息，减少刷屏。
    - `❌ 删除该节目` → **根据节目类型进入不同菜单**：
        - **若为电影**：
            - `⏏️ 从Emby中删除节目`：仅从媒体库移除（需要 Emby 用户名/密码）。
            - `🗑️ 删除本地文件`：删除 `media_base_path` 下对应目录。
            - `☁️ 删除网盘文件`：删除 `media_cloud_path` 下对应目录。
            - `💥 删除本地和网盘文件`：双删。
        - **若为剧集**：将看到一个功能更强大的**分层删除菜单**：
            - `❌ 删除整个剧集`：点击后效果同上，会删除整个剧集的所有相关项目。
            - `❌ 删除季`：
                1. 机器人会提示您**输入要删除的季号**。
                2. 您可以输入如 `S01 S03` 或 `1 3 5` 这样的格式。
                3. 确认后，机器人会再次让您选择删除范围（从Emby、本地文件、网盘文件、或全部）。
            - `❌ 删除集`：
                1. 机器人会提示您**输入要删除的集号**。
                2. 您可以输入复杂的范围，如 `S01E03 E11 S02E03-E06 E10`。省略季号时会自动沿用上一个季号。
                3. 确认后，机器人会再次让您选择删除范围。
        - **所有删除类操作**均有二次确认；执行后返回详细结果。

---

## 二、从网盘更新一个新节目
### 目录规范
- 目标目录：`<settings.media_cloud_path>/<类型>/<名称 (年份)>`
  - 例：`/opt/Cloud/华语电影/西虹市首富 (2018)`
- 推荐 `.nfo`：
  - 剧集用 `tvshow.nfo`（强制按剧集解析 TMDB）。
  - 支持常见写法：
    - `<uniqueid type="tmdb" default="true">538331</uniqueid>`
    - `<tmdbid>538331</tmdbid>`
    - 文本中包含 `themoviedb.org/{movie|tv}/538331`

### 识别规则（电影/剧集）
- 若 **存在 `tvshow.nfo`** → **强制当剧集 (tv)** 解析 TMDB。
- 若 **你输入的“类型”包含“电影”**（如“华语电影”）→ **优先当电影 (movie)** 解析；若失败会做一次 TV 回退尝试。
- 其余场景 → 自动尝试 `tv` → `movie`。

### 操作步骤
1. **进入入口**：`/manage` → 点击 `⬇️ 从网盘更新一个新节目`。
2. **按提示输入**：`节目名称 年份 类型`，空格分隔（例：`西虹市首富 2018 华语电影`）。
3. **校验与解析**：机器人会：
    - 模糊匹配网盘中包含 `名称` 和 `年份` 的目录；
    - 查找 `.nfo` 并解析 TMDB ID；
    - 按“识别规则”调用 TMDB 获取标题/海报/剧情等。
4. **确认卡片**：展示“名称（含年份）/类型/分类/剧情/海报” + 按钮 `⬇️ 确认并开始更新`。
5. **执行同步**：点击按钮后开始：
    - 复制元数据与文本类文件到主库；
    - 为媒体文件生成 `.strm`；
    - 完成后编辑原卡片为“摘要”，并另发**详细明细**。
6. **自动清理**：确认卡片与明细会在一段时间后自动删除。

---

### 相关设置开关（路径）
- 搜索/详情展示类同 `/search`（`settings.content_settings.search_display.*`）；
- “在服务器中查看”按钮：相关分组各自的 `show_view_on_server_button`；
- 自动删除：`settings.auto_delete_settings.*`；
- 通知类开关（若你结合 Webhook 使用新增/删除通知）：`settings.notification_management.*` 与各自内容项。

---

### 常见问题 & 排错
- **“未找到网盘目录”**：确认目录名称与输入一致，或至少包含输入的 `名称` 和 `年份` 关键字。
- **“.nfo 无 TMDB ID”**：请在 `.nfo` 中提供 `<uniqueid type="tmdb">` 或 `<tmdbid>`，或放入 TMDB 链接。
- **电影/剧集识别错误**：优先在网盘目录放置 `tvshow.nfo`（剧集），或在输入的“类型”里明确包含“电影”。
- **删除 Emby 失败**：请在配置中填写 `emby.username` 与 `emby.password` 以获取 Access Token。
- **更新后“没变化”**：本地已最新则会提示“无需更新”；请仔细查看机器人返回的明细。
- **消息重复/没编辑成功**：网络抖动时，机器人会降级改为“另发独立文本”，不影响结果可读性。
